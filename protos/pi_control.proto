syntax = "proto3";

package picontrol;

option go_package = "pi_agent/proto";

// ==================== Services ====================

service SystemMonitor {
  // Stream real-time system statistics (CPU, RAM, temp, etc.)
  rpc StreamStats (Empty) returns (stream LiveStats);

  // Get list of all running processes
  rpc ListProcesses (Empty) returns (ProcessList);

  // Kill a specific process by PID
  rpc KillProcess (ProcessId) returns (ActionStatus);

  // List all systemd services
  rpc ListServices (Empty) returns (ServiceList);

  // Control a systemd service (start/stop/restart/enable/disable)
  rpc ManageService (ServiceCommand) returns (ActionStatus);

  // Stream system logs in real-time
  rpc StreamLogs (LogFilter) returns (stream LogEntry);

  // Get disk usage information
  rpc GetDiskInfo (Empty) returns (DiskInfo);

  // Get network interface information
  rpc GetNetworkInfo (Empty) returns (NetworkInfo);

  // Get active network connections
  rpc GetNetworkConnections (Empty) returns (NetworkConnectionList);

  // List installed packages (optionally filter)
  rpc ListPackages (PackageFilter) returns (PackageList);

  // Install a package
  rpc InstallPackage (PackageCommand) returns (ActionStatus);

  // Remove a package
  rpc RemovePackage (PackageCommand) returns (ActionStatus);

  // Update a specific package
  rpc UpdatePackage (PackageCommand) returns (ActionStatus);

  // Update package list (apt update)
  rpc UpdatePackageList (Empty) returns (ActionStatus);

  // Upgrade packages (apt upgrade)
  rpc UpgradePackages (Empty) returns (ActionStatus);

  // Get agent version
  rpc GetVersion (Empty) returns (VersionInfo);

  // Get detailed package information
  rpc GetPackageDetails (PackageDetailsRequest) returns (PackageDetails);

  // Get package dependencies
  rpc GetPackageDependencies (PackageDetailsRequest) returns (PackageDependencies);

  // Stream package operation logs (install/remove/update)
  rpc StreamPackageOperation (PackageCommand) returns (stream PackageOperationLog);

  // Network Tools
  // Ping a host and stream results
  rpc PingHost (PingRequest) returns (stream PingResponse);

  // Scan ports on a target host
  rpc ScanPorts (PortScanRequest) returns (stream PortScanResponse);

  // DNS lookup
  rpc DNSLookup (DNSRequest) returns (DNSResponse);

  // Traceroute to a host
  rpc Traceroute (TracerouteRequest) returns (stream TracerouteResponse);

  // Get WiFi information
  rpc GetWifiInfo (Empty) returns (WifiInfo);

  // Test network speed (download/upload)
  rpc TestNetworkSpeed (SpeedTestRequest) returns (stream SpeedTestResponse);

  // File Transfer
  // Upload a file using streaming chunks
  rpc UploadFile (stream FileChunk) returns (FileUploadResponse);

  // Download a file as streaming chunks
  rpc DownloadFile (FileDownloadRequest) returns (stream FileChunk);

  // Delete a file or directory
  rpc DeleteFile (FileDeleteRequest) returns (FileDeleteResponse);

  // System Updates
  // Get system update status (OS info, kernel, upgradable packages)
  rpc GetSystemUpdateStatus (Empty) returns (SystemUpdateStatus);

  // Stream system upgrade progress (apt update + apt upgrade)
  rpc StreamSystemUpgrade (Empty) returns (stream UpgradeProgress);
}

// ==================== Messages ====================

message Empty {}

// Real-time system statistics
message LiveStats {
  // CPU usage percentage (0-100)
  double cpu_usage = 1;

  // Per-core CPU usage
  repeated double cpu_per_core = 2;

  // RAM usage in bytes
  uint64 ram_used = 3;
  uint64 ram_total = 4;
  uint64 ram_free = 5;
  uint64 ram_cached = 6;

  // Swap usage in bytes
  uint64 swap_used = 7;
  uint64 swap_total = 8;

  // CPU temperature in Celsius
  double cpu_temp = 9;

  // GPU temperature in Celsius (if available)
  double gpu_temp = 10;

  // System uptime in seconds
  uint64 uptime = 11;

  // Load averages
  double load_1min = 12;
  double load_5min = 13;
  double load_15min = 14;

  // Network stats (bytes per second)
  uint64 net_bytes_sent = 15;
  uint64 net_bytes_recv = 16;

  // Top processes by CPU usage
  repeated ProcessInfo top_processes = 17;

  // Timestamp of this stat snapshot
  int64 timestamp = 18;

  // Disk I/O stats (bytes per second)
  repeated DiskIOStat disk_io = 19;
}

// Process information
message ProcessInfo {
  int32 pid = 1;
  string name = 2;
  double cpu_percent = 3;
  double memory_percent = 4;
  uint64 memory_bytes = 5;
  string status = 6;
  string username = 7;
  string cmdline = 8;
}

// List of all processes
message ProcessList {
  repeated ProcessInfo processes = 1;
}

// Process ID for kill operations
message ProcessId {
  int32 pid = 1;
}

// Service information
message ServiceInfo {
  string name = 1;
  string status = 2; // active, inactive, failed, etc.
  string description = 3;
  bool enabled = 4;
  string sub_state = 5; // running, dead, exited, etc.
}

// List of all services
message ServiceList {
  repeated ServiceInfo services = 1;
}

// Service control command
message ServiceCommand {
  string service_name = 1;
  ServiceAction action = 2;
}

enum ServiceAction {
  START = 0;
  STOP = 1;
  RESTART = 2;
  ENABLE = 3;
  DISABLE = 4;
  RELOAD = 5;
}

// Generic action status response
message ActionStatus {
  bool success = 1;
  string message = 2;
  int32 error_code = 3;
}

// Log filter options
message LogFilter {
  // Filter by log level (empty = all)
  repeated string levels = 1; // error, warning, info, debug

  // Filter by service name (empty = all)
  string service = 2;

  // Number of past lines to include (0 = only new)
  int32 tail_lines = 3;
}

// Single log entry
message LogEntry {
  int64 timestamp = 1;
  string level = 2;
  string service = 3;
  string message = 4;
}

// Disk usage information
message DiskInfo {
  repeated DiskPartition partitions = 1;
}

message DiskPartition {
  string device = 1;
  string mount_point = 2;
  string filesystem = 3;
  uint64 total_bytes = 4;
  uint64 used_bytes = 5;
  uint64 free_bytes = 6;
  double usage_percent = 7;
}

// Network interface information
message NetworkInfo {
  repeated NetworkInterface interfaces = 1;
}

message NetworkInterface {
  string name = 1;
  repeated string addresses = 2;
  string mac_address = 3;
  bool is_up = 4;
  uint64 bytes_sent = 5;
  uint64 bytes_recv = 6;
  uint64 packets_sent = 7;
  uint64 packets_recv = 8;
}

// Network connection information
message NetworkConnectionList {
  repeated NetworkConnection connections = 1;
}

message NetworkConnection {
  string protocol = 1; // TCP, UDP, etc.
  string local_address = 2;
  int32 local_port = 3;
  string remote_address = 4;
  int32 remote_port = 5;
  string status = 6; // ESTABLISHED, LISTEN, TIME_WAIT, etc.
  int32 pid = 7;
  string process_name = 8;
}

// Package management
message PackageFilter {
  string search_term = 1; // Empty = list all installed
  bool installed_only = 2; // If true, only show installed packages
}

message PackageInfo {
  string name = 1;
  string version = 2;
  string architecture = 3;
  string description = 4;
  bool installed = 5;
  string status = 6; // installed, not-installed, upgradable
  uint64 installed_size = 7; // Size in bytes (0 if not installed)
  string section = 8; // Package category (utils, libs, net, etc.)
}

message PackageList {
  repeated PackageInfo packages = 1;
}

message PackageCommand {
  string package_name = 1;
}

// Request for detailed package information
message PackageDetailsRequest {
  string package_name = 1;
}

// Detailed package information
message PackageDetails {
  string name = 1;
  string version = 2;
  string architecture = 3;
  string description = 4;
  string long_description = 5; // Full README-style description
  bool installed = 6;
  string status = 7;
  uint64 installed_size = 8; // Size in bytes
  string maintainer = 9; // Maintainer name and email
  string homepage = 10; // Project homepage/GitHub URL
  string section = 11; // Package category
  int64 install_date = 12; // Unix timestamp (0 if not installed)
  repeated string tags = 13; // Package tags/keywords
  string source = 14; // Source package name
  int32 priority = 15; // Package priority (required, important, standard, optional, extra)
  string license = 16; // License type (MIT, GPL, etc.)
}

// Package dependency information
message PackageDependencies {
  string package_name = 1;
  repeated string depends = 2; // Packages this one requires
  repeated string required_by = 3; // Packages that require this one
  repeated string recommends = 4; // Recommended packages
  repeated string suggests = 5; // Suggested packages
  repeated string conflicts = 6; // Conflicting packages
}

// Log entry for package operations
message PackageOperationLog {
  int64 timestamp = 1;
  string level = 2; // info, warning, error
  string message = 3;
  double progress = 4; // 0-100 percentage
  bool completed = 5; // True when operation is done
  bool success = 6; // True if operation succeeded
}

// Disk I/O statistics
message DiskIOStat {
  string device = 1; // e.g., "sda", "nvme0n1"
  uint64 read_bytes = 2; // Bytes read per second
  uint64 write_bytes = 3; // Bytes written per second
  uint64 read_count = 4; // Read operations per second
  uint64 write_count = 5; // Write operations per second
}

// Version information
message VersionInfo {
  string version = 1; // Agent version string (e.g., "3.1.0")
  bool is_root = 2; // Whether agent is running with root privileges
}

// ==================== Network Tools Messages ====================

// Ping request
message PingRequest {
  string host = 1; // Hostname or IP address to ping
  int32 count = 2; // Number of pings (0 = continuous until cancelled)
  int32 timeout = 3; // Timeout in seconds per ping (default: 5)
  int32 packet_size = 4; // Packet size in bytes (default: 56)
}

// Ping response (streamed)
message PingResponse {
  bool success = 1; // Whether ping was successful
  string host = 2; // Target host
  string ip = 3; // Resolved IP address
  double latency = 4; // Latency in milliseconds
  int32 sequence = 5; // Sequence number
  int32 ttl = 6; // Time to live
  string error = 7; // Error message if failed
  bool finished = 8; // True when all pings complete
  PingStats statistics = 9; // Final statistics (only in last message)
}

// Ping statistics
message PingStats {
  int32 packets_sent = 1;
  int32 packets_received = 2;
  double packet_loss = 3; // Percentage
  double min_latency = 4; // ms
  double max_latency = 5; // ms
  double avg_latency = 6; // ms
}

// Port scan request
message PortScanRequest {
  string host = 1; // Target hostname or IP
  repeated int32 ports = 2; // Specific ports to scan (if empty, scan common ports)
  int32 start_port = 3; // Start of port range (alternative to ports list)
  int32 end_port = 4; // End of port range
  int32 timeout = 5; // Timeout per port in milliseconds (default: 1000)
}

// Port scan response (streamed)
message PortScanResponse {
  int32 port = 1;
  bool open = 2;
  string service = 3; // Service name if known
  string error = 4;
  bool finished = 5; // True when scan completes
  int32 progress = 6; // Progress percentage (0-100)
}

// DNS lookup request
message DNSRequest {
  string hostname = 1;
  string record_type = 2; // A, AAAA, MX, TXT, NS, CNAME, etc. (default: A)
}

// DNS lookup response
message DNSResponse {
  bool success = 1;
  string hostname = 2;
  repeated string addresses = 3; // IP addresses or records
  repeated DNSRecord records = 4; // Detailed records
  double query_time = 5; // Query time in milliseconds
  string error = 6;
}

// DNS record details
message DNSRecord {
  string type = 1; // A, AAAA, MX, etc.
  string value = 2;
  int32 ttl = 3; // Time to live
  int32 priority = 4; // For MX records
}

// Traceroute request
message TracerouteRequest {
  string host = 1;
  int32 max_hops = 2; // Maximum number of hops (default: 30)
  int32 timeout = 3; // Timeout per hop in seconds (default: 5)
}

// Traceroute response (streamed)
message TracerouteResponse {
  int32 hop = 1; // Hop number
  string ip = 2; // IP address of this hop
  string hostname = 3; // Hostname if resolved
  double latency = 4; // Latency in milliseconds
  bool timeout = 5; // True if hop timed out
  bool finished = 6; // True when traceroute completes
  string error = 7;
}

// WiFi information
message WifiInfo {
  bool connected = 1;
  string ssid = 2; // Network name
  string bssid = 3; // MAC address of access point
  int32 signal_strength = 4; // Signal strength in dBm (-100 to 0)
  int32 signal_quality = 5; // Signal quality percentage (0-100)
  double frequency = 6; // Frequency in GHz (2.4 or 5.0)
  string security = 7; // WPA2, WPA3, etc.
  double link_speed = 8; // Link speed in Mbps
  string ip_address = 9;
  repeated WifiNetwork available_networks = 10;
}

// Available WiFi network
message WifiNetwork {
  string ssid = 1;
  string bssid = 2;
  int32 signal_strength = 3;
  int32 signal_quality = 4;
  double frequency = 5;
  string security = 6;
}

// Speed test request
message SpeedTestRequest {
  bool test_download = 1; // Test download speed
  bool test_upload = 2; // Test upload speed
  int32 duration = 3; // Test duration in seconds (default: 10)
}

// Speed test response (streamed)
message SpeedTestResponse {
  string phase = 1; // "connecting", "download", "upload", "complete"
  double download_speed = 2; // Current download speed in Mbps
  double upload_speed = 3; // Current upload speed in Mbps
  double progress = 4; // Progress percentage (0-100)
  double latency = 5; // Server latency in ms
  string server = 6; // Test server location
  bool finished = 7;
  string error = 8;
}

// ==================== File Transfer Messages ====================

// File chunk for streaming transfers
message FileChunk {
  string path = 1; // Remote file path (relative to agent's working directory)
  bytes data = 2; // Chunk data (max 256KB recommended)
  int64 offset = 3; // Byte offset in the file
  int64 total_size = 4; // Total file size in bytes (set in first chunk)
  bool is_final = 5; // True for the last chunk
  string error = 6; // Error message if something went wrong
}

// Upload response (after all chunks received)
message FileUploadResponse {
  bool success = 1;
  string path = 2; // Path where file was written
  int64 bytes_written = 3; // Total bytes written
  string error = 4; // Error message if failed
  double duration = 5; // Upload duration in seconds
}

// Download request
message FileDownloadRequest {
  string path = 1; // Remote file path to download
  int64 offset = 2; // Starting byte offset (0 for full file, >0 to resume)
}

// Delete request
message FileDeleteRequest {
  string path = 1; // Remote file or directory path to delete
  bool is_directory = 2; // True if deleting a directory (will delete recursively)
}

// Delete response
message FileDeleteResponse {
  bool success = 1;
  string path = 2; // Path that was deleted
  string error = 3; // Error message if failed
}

// ==================== Docker Management Services ====================

service DockerService {
  // List containers
  rpc ListContainers (DockerFilter) returns (ContainerList);

  // Start a container
  rpc StartContainer (ContainerId) returns (ActionStatus);

  // Stop a container
  rpc StopContainer (ContainerId) returns (ActionStatus);

  // Restart a container
  rpc RestartContainer (ContainerId) returns (ActionStatus);

  // Get container logs
  rpc GetContainerLogs (LogRequest) returns (stream LogEntry);
}

// ==================== Docker Messages ====================

message DockerFilter {
  bool all = 1; // Show all containers (default shows just running)
}

message ContainerId {
  string id = 1;
}

message ContainerList {
  repeated ContainerInfo containers = 1;
}

message ContainerInfo {
  string id = 1;
  repeated string names = 2;
  string image = 3;
  string state = 4; // created, restarting, running, removing, paused, exited, dead
  string status = 5; // Human readable status
  int64 created = 6;
  repeated string ports = 7;
}

message LogRequest {
  string container_id = 1;
  bool follow = 2; // Stream logs
  int32 tail = 3; // Number of lines to show from the end
}

// ==================== System Update Messages ====================

message SystemUpdateStatus {
  string os_name = 1;          // e.g. "Debian GNU/Linux 12 (bookworm)"
  string kernel_version = 2;   // e.g. "6.1.0-rpi7-rpi-v8"
  string architecture = 3;     // e.g. "aarch64"
  int32 upgradable_count = 4;  // Number of packages that can be upgraded
  repeated UpgradablePackage upgradable_packages = 5;
  string last_update = 6;      // Timestamp of last apt update
  string uptime = 7;           // System uptime string
}

message UpgradablePackage {
  string name = 1;
  string current_version = 2;
  string new_version = 3;
  string architecture = 4;
}

message UpgradeProgress {
  string line = 1;        // Output line from apt
  string phase = 2;       // "update", "upgrade", "done", "error"
  int32 percent = 3;      // Progress percentage (0-100) if available
  bool is_complete = 4;   // Whether the entire operation is done
  bool success = 5;       // Whether it completed successfully
}
