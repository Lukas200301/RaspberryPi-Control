syntax = "proto3";

package picontrol;

option go_package = "pi_agent/proto";

// ==================== Services ====================

service SystemMonitor {
  // Stream real-time system statistics (CPU, RAM, temp, etc.)
  rpc StreamStats (Empty) returns (stream LiveStats);

  // Get list of all running processes
  rpc ListProcesses (Empty) returns (ProcessList);

  // Kill a specific process by PID
  rpc KillProcess (ProcessId) returns (ActionStatus);

  // List all systemd services
  rpc ListServices (Empty) returns (ServiceList);

  // Control a systemd service (start/stop/restart/enable/disable)
  rpc ManageService (ServiceCommand) returns (ActionStatus);

  // Stream system logs in real-time
  rpc StreamLogs (LogFilter) returns (stream LogEntry);

  // Get disk usage information
  rpc GetDiskInfo (Empty) returns (DiskInfo);

  // Get network interface information
  rpc GetNetworkInfo (Empty) returns (NetworkInfo);

  // Get active network connections
  rpc GetNetworkConnections (Empty) returns (NetworkConnectionList);

  // List installed packages (optionally filter)
  rpc ListPackages (PackageFilter) returns (PackageList);

  // Install a package
  rpc InstallPackage (PackageCommand) returns (ActionStatus);

  // Remove a package
  rpc RemovePackage (PackageCommand) returns (ActionStatus);

  // Update a specific package
  rpc UpdatePackage (PackageCommand) returns (ActionStatus);

  // Update package list (apt update)
  rpc UpdatePackageList (Empty) returns (ActionStatus);

  // Upgrade packages (apt upgrade)
  rpc UpgradePackages (Empty) returns (ActionStatus);

  // Get agent version
  rpc GetVersion (Empty) returns (VersionInfo);

  // Get detailed package information
  rpc GetPackageDetails (PackageDetailsRequest) returns (PackageDetails);

  // Get package dependencies
  rpc GetPackageDependencies (PackageDetailsRequest) returns (PackageDependencies);

  // Stream package operation logs (install/remove/update)
  rpc StreamPackageOperation (PackageCommand) returns (stream PackageOperationLog);
}

// ==================== Messages ====================

message Empty {}

// Real-time system statistics
message LiveStats {
  // CPU usage percentage (0-100)
  double cpu_usage = 1;

  // Per-core CPU usage
  repeated double cpu_per_core = 2;

  // RAM usage in bytes
  uint64 ram_used = 3;
  uint64 ram_total = 4;
  uint64 ram_free = 5;
  uint64 ram_cached = 6;

  // Swap usage in bytes
  uint64 swap_used = 7;
  uint64 swap_total = 8;

  // CPU temperature in Celsius
  double cpu_temp = 9;

  // GPU temperature in Celsius (if available)
  double gpu_temp = 10;

  // System uptime in seconds
  uint64 uptime = 11;

  // Load averages
  double load_1min = 12;
  double load_5min = 13;
  double load_15min = 14;

  // Network stats (bytes per second)
  uint64 net_bytes_sent = 15;
  uint64 net_bytes_recv = 16;

  // Top processes by CPU usage
  repeated ProcessInfo top_processes = 17;

  // Timestamp of this stat snapshot
  int64 timestamp = 18;

  // Disk I/O stats (bytes per second)
  repeated DiskIOStat disk_io = 19;
}

// Process information
message ProcessInfo {
  int32 pid = 1;
  string name = 2;
  double cpu_percent = 3;
  double memory_percent = 4;
  uint64 memory_bytes = 5;
  string status = 6;
  string username = 7;
  string cmdline = 8;
}

// List of all processes
message ProcessList {
  repeated ProcessInfo processes = 1;
}

// Process ID for kill operations
message ProcessId {
  int32 pid = 1;
}

// Service information
message ServiceInfo {
  string name = 1;
  string status = 2; // active, inactive, failed, etc.
  string description = 3;
  bool enabled = 4;
  string sub_state = 5; // running, dead, exited, etc.
}

// List of all services
message ServiceList {
  repeated ServiceInfo services = 1;
}

// Service control command
message ServiceCommand {
  string service_name = 1;
  ServiceAction action = 2;
}

enum ServiceAction {
  START = 0;
  STOP = 1;
  RESTART = 2;
  ENABLE = 3;
  DISABLE = 4;
  RELOAD = 5;
}

// Generic action status response
message ActionStatus {
  bool success = 1;
  string message = 2;
  int32 error_code = 3;
}

// Log filter options
message LogFilter {
  // Filter by log level (empty = all)
  repeated string levels = 1; // error, warning, info, debug

  // Filter by service name (empty = all)
  string service = 2;

  // Number of past lines to include (0 = only new)
  int32 tail_lines = 3;
}

// Single log entry
message LogEntry {
  int64 timestamp = 1;
  string level = 2;
  string service = 3;
  string message = 4;
}

// Disk usage information
message DiskInfo {
  repeated DiskPartition partitions = 1;
}

message DiskPartition {
  string device = 1;
  string mount_point = 2;
  string filesystem = 3;
  uint64 total_bytes = 4;
  uint64 used_bytes = 5;
  uint64 free_bytes = 6;
  double usage_percent = 7;
}

// Network interface information
message NetworkInfo {
  repeated NetworkInterface interfaces = 1;
}

message NetworkInterface {
  string name = 1;
  repeated string addresses = 2;
  string mac_address = 3;
  bool is_up = 4;
  uint64 bytes_sent = 5;
  uint64 bytes_recv = 6;
  uint64 packets_sent = 7;
  uint64 packets_recv = 8;
}

// Network connection information
message NetworkConnectionList {
  repeated NetworkConnection connections = 1;
}

message NetworkConnection {
  string protocol = 1; // TCP, UDP, etc.
  string local_address = 2;
  int32 local_port = 3;
  string remote_address = 4;
  int32 remote_port = 5;
  string status = 6; // ESTABLISHED, LISTEN, TIME_WAIT, etc.
  int32 pid = 7;
  string process_name = 8;
}

// Package management
message PackageFilter {
  string search_term = 1; // Empty = list all installed
  bool installed_only = 2; // If true, only show installed packages
}

message PackageInfo {
  string name = 1;
  string version = 2;
  string architecture = 3;
  string description = 4;
  bool installed = 5;
  string status = 6; // installed, not-installed, upgradable
  uint64 installed_size = 7; // Size in bytes (0 if not installed)
  string section = 8; // Package category (utils, libs, net, etc.)
}

message PackageList {
  repeated PackageInfo packages = 1;
}

message PackageCommand {
  string package_name = 1;
}

// Request for detailed package information
message PackageDetailsRequest {
  string package_name = 1;
}

// Detailed package information
message PackageDetails {
  string name = 1;
  string version = 2;
  string architecture = 3;
  string description = 4;
  string long_description = 5; // Full README-style description
  bool installed = 6;
  string status = 7;
  uint64 installed_size = 8; // Size in bytes
  string maintainer = 9; // Maintainer name and email
  string homepage = 10; // Project homepage/GitHub URL
  string section = 11; // Package category
  int64 install_date = 12; // Unix timestamp (0 if not installed)
  repeated string tags = 13; // Package tags/keywords
  string source = 14; // Source package name
  int32 priority = 15; // Package priority (required, important, standard, optional, extra)
  string license = 16; // License type (MIT, GPL, etc.)
}

// Package dependency information
message PackageDependencies {
  string package_name = 1;
  repeated string depends = 2; // Packages this one requires
  repeated string required_by = 3; // Packages that require this one
  repeated string recommends = 4; // Recommended packages
  repeated string suggests = 5; // Suggested packages
  repeated string conflicts = 6; // Conflicting packages
}

// Log entry for package operations
message PackageOperationLog {
  int64 timestamp = 1;
  string level = 2; // info, warning, error
  string message = 3;
  double progress = 4; // 0-100 percentage
  bool completed = 5; // True when operation is done
  bool success = 6; // True if operation succeeded
}

// Disk I/O statistics
message DiskIOStat {
  string device = 1; // e.g., "sda", "nvme0n1"
  uint64 read_bytes = 2; // Bytes read per second
  uint64 write_bytes = 3; // Bytes written per second
  uint64 read_count = 4; // Read operations per second
  uint64 write_count = 5; // Write operations per second
}

// Version information
message VersionInfo {
  string version = 1; // Agent version string (e.g., "3.1.0")
  bool is_root = 2; // Whether agent is running with root privileges
}
